<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../at-theme/at-theme.html">
<link rel="import" href="../at-carbon-moment/momentjs-import.html">

<dom-module id="at-core-dashboard-echo">
  <template>
    <style include="at-form-common"></style>
    <style>
    </style>
    <div class="at-container">
      <div id="insertPoint" class="at-content">

      </div>
    </div>
  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-core-dashboard-echo',

      properties: {
        template: {
          type: String,
          value: ""
        },
        modelRoot: {
          type: String,
          value: ""
        }
      },

      $meta: [{
        title: "Dashboard echo",
        type: "element",
        xtype: "at-core-dashboard-echo"
      }],

      ready: function () {

      },

      _getObjPath: function (obj, path) {

        if (!path) return obj;
        var paths = path.split('.'), current = obj;
      
        for (var i = 0; i < paths.length; ++i) {
          if (current[paths[i]] == undefined) {
            return undefined;
          } else {
            current = current[paths[i]];
          }
        }
        return current;
      },

      actionListener: function (event) {

        function isArray(obj) {
          return Object.prototype.toString.call(obj) === "[object Array]";
        }
        function isEmptyString(obj) {
          return Object.prototype.toString.call(obj) === "[object String]" && obj === "";
        }

        var template = this.template;
   
        if (isEmptyString(template)) {
          Polymer.dom(this.$.insertPoint).innerHTML = "";
          var jsonDiv = this.create('div');
          var jsonPre = this.create('pre');
          Polymer.dom(jsonDiv).appendChild(jsonPre);
          var eventJson = JSON.stringify(this.modelRoot ? this._getObjPath(event.detail.model, this.modelRoot) : event, null, " ");
          var nowStr = moment().format("HH:mm:ss");
          jsonPre.textContent = nowStr + " " + this.modelRoot + ": " + eventJson;
          Polymer.dom(this.$.insertPoint).appendChild(jsonDiv);
          return;
        }
                
        var state = this.modelRoot ? this._getObjPath(event.detail.model, this.modelRoot) : event.detail.model.state;

        var matchedParts = template.match(/\{\{([\w]+)\}\}/gm);
        if (!matchedParts) {
          return;
        }

        var insertPoint = this.$.insertPoint;
        Polymer.dom(insertPoint).innerHTML = "";
        var divPrototype = document.createElement('div');
        var docFragment = document.createDocumentFragment();

        matchedParts.forEach(function (matchedPart, index) {
          var fieldName = matchedPart.substring((matchedPart.indexOf("{{") + 2), matchedPart.indexOf("}}"));
          var div = divPrototype.cloneNode(true);
          var value = template.replace(matchedPart, state[fieldName]);
          div.textContent = value;
          Polymer.dom(docFragment).appendChild(div);
        });

        Polymer.dom(insertPoint).appendChild(docFragment);
      }
    });
  </script>
</dom-module>
